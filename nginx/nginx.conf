# Nginx 설정 파일
# Nginx는 리버스 프록시 역할: 사용자 요청을 받아서 Spring Boot로 전달

# ============================================
# 이벤트 설정
# ============================================
events {
    # 워커 프로세스 하나가 동시에 처리할 수 있는 연결 수
    # 1024면 충분함 (소규모 서비스 기준)
    worker_connections 1024;
}

# ============================================
# HTTP 설정
# ============================================
http {
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }
    # ----------------------------------------
    # 백엔드 서버 정의 (업스트림)
    # ----------------------------------------
    # 'backend'라는 이름으로 Spring Boot 서버 그룹 정의
    # app:8080 - 'app'은 docker-compose.yml의 컨테이너 이름
    upstream backend {
        server app:8080;
    }

    # ----------------------------------------
    # HTTP 서버 설정 (포트 80)
    # ----------------------------------------
    server {
        # 80번 포트로 들어오는 요청 처리
        listen 80;

        # 서버 이름 (도메인이 없으면 _ 사용)
        # 나중에 도메인 연결하면 'your-domain.com'으로 변경
        server_name _;

        # ====================================
        # 일반 HTTP 요청 처리
        # ====================================
        location / {
            # 모든 요청을 backend (Spring Boot)로 전달
            proxy_pass http://backend;

            # 원본 Host 헤더 유지 (Spring Boot가 정확한 도메인 알 수 있게)
            proxy_set_header Host $host;

            # 실제 클라이언트 IP 전달 (로그에 사용자 IP 기록)
            proxy_set_header X-Real-IP $remote_addr;

            # 프록시 체인의 모든 IP 전달
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # 프로토콜 정보 전달 (http or https)
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ====================================
        # WebSocket 요청 처리 (/ws 정확히 매칭)
        # ====================================
        location = /ws {
            # WebSocket 요청도 backend로 전달
            proxy_pass http://backend;

            # HTTP/1.1 사용 (WebSocket은 HTTP/1.1 필요)
            proxy_http_version 1.1;

            # WebSocket 업그레이드 헤더 전달
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Sec-WebSocket-Protocol $http_sec_websocket_protocol;
            proxy_set_header Sec-WebSocket-Extensions "";

            # 기본 헤더들
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # WebSocket 버퍼링 비활성화 (프레임 분할 방지)
            proxy_buffering off;
            proxy_request_buffering off;

            # WebSocket 타임아웃 설정 (기본값보다 길게)
            proxy_read_timeout 86400s;  # 24시간
            proxy_send_timeout 86400s;  # 24시간
        }
    }

    # ----------------------------------------
    # HTTPS 서버 설정 (포트 443) - 나중에 활성화
    # ----------------------------------------
    # SSL 인증서 발급 후 아래 주석을 해제하고 사용
    # server {
    #     listen 443 ssl;
    #     server_name your-domain.com;
    #
    #     # SSL 인증서 파일 경로
    #     ssl_certificate /etc/nginx/ssl/fullchain.pem;
    #     ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    #
    #     # SSL 보안 설정
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers HIGH:!aNULL:!MD5;
    #
    #     # 나머지 location 설정은 위와 동일
    #     location / {
    #         proxy_pass http://backend;
    #         proxy_set_header Host $host;
    #         proxy_set_header X-Real-IP $remote_addr;
    #         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #         proxy_set_header X-Forwarded-Proto $scheme;
    #     }
    #
    #     location /ws/ {
    #         proxy_pass http://backend;
    #         proxy_http_version 1.1;
    #         proxy_set_header Upgrade $upgrade;
    #         proxy_set_header Connection "upgrade";
    #         proxy_set_header Host $host;
    #         proxy_set_header X-Real-IP $remote_addr;
    #         proxy_read_timeout 86400s;
    #         proxy_send_timeout 86400s;
    #     }
    # }
}

# ============================================
# 설정 테스트 방법:
# ============================================
# 컨테이너 안에서 설정 검증:
#   docker exec safetyfence-nginx nginx -t
#
# 설정 변경 후 재시작:
#   docker-compose restart nginx
# ============================================
