services:
  # ============================================
  # 1. Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„
  # ============================================
  nginx:
    image: nginx:stable-alpine  # ê²½ëŸ‰í™”ëœ nginx ì´ë¯¸ì§€ ì‚¬ìš©
    container_name: safetyfence-nginx

    # í¬íŠ¸ ë§¤í•‘: "í˜¸ìŠ¤íŠ¸í¬íŠ¸:ì»¨í…Œì´ë„ˆí¬íŠ¸"
    ports:
      - "80:80"    # HTTP - ì™¸ë¶€ 80ë²ˆ í¬íŠ¸ë¥¼ ì»¨í…Œì´ë„ˆ 80ë²ˆìœ¼ë¡œ ì—°ê²°
      - "443:443"  # HTTPS - SSL ì„¤ì • í›„ ì‚¬ìš© (ì²˜ìŒì—” ì‚¬ìš© ì•ˆí•¨)

    # ë³¼ë¥¨ ë§ˆìš´íŠ¸: ë¡œì»¬ íŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ì•ˆìœ¼ë¡œ ì—°ê²°
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf  # Nginx ì„¤ì • íŒŒì¼
      - ./nginx/ssl:/etc/nginx/ssl                # SSL ì¸ì¦ì„œ í´ë” (ë‚˜ì¤‘ì— ìƒê¹€)

    # ì˜ì¡´ì„±: app ì»¨í…Œì´ë„ˆê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•¨
    depends_on:
      - app

    # ì¬ì‹œì‘ ì •ì±…: ì»¨í…Œì´ë„ˆê°€ ì£½ìœ¼ë©´ ìë™ìœ¼ë¡œ ì¬ì‹œì‘ (ìˆ˜ë™ ì¤‘ì§€ ì œì™¸)
    restart: unless-stopped

    # ë„¤íŠ¸ì›Œí¬: ê°™ì€ ë„¤íŠ¸ì›Œí¬ì— ìˆì–´ì•¼ ì»¨í…Œì´ë„ˆë¼ë¦¬ í†µì‹  ê°€ëŠ¥
    networks:
      - safetyfence-net

  # ============================================
  # 2. Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë²„
  # ============================================
  app:
    # Dockerfileì„ ì´ìš©í•´ì„œ ì´ë¯¸ì§€ ë¹Œë“œ
    build:
      context: .              # í˜„ì¬ ë””ë ‰í† ë¦¬ì—ì„œ
      dockerfile: Dockerfile  # Dockerfileì„ ì°¾ì•„ì„œ ë¹Œë“œ

    container_name: safetyfence-app

    # í¬íŠ¸ ë§¤í•‘
    ports:
      - "8080:8080"  # Spring Boot ê¸°ë³¸ í¬íŠ¸

    # í™˜ê²½ ë³€ìˆ˜: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì‚¬ìš©ë˜ëŠ” ë³€ìˆ˜ë“¤
    environment:
      # í”„ë¡œë•ì…˜ ëª¨ë“œë¡œ ì‹¤í–‰ (application-prod.properties ì‚¬ìš©)
      - SPRING_PROFILES_ACTIVE=prod

      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ë³´
      # db:5432 - 'db'ëŠ” ì•„ë˜ PostgreSQL ì»¨í…Œì´ë„ˆ ì´ë¦„
      - SPRING_DATASOURCE_URL=jdbc:postgresql://db:5432/safetyfence_db

      # .env íŒŒì¼ì—ì„œ ê°€ì ¸ì˜¬ ê°’ë“¤ (${ë³€ìˆ˜ëª…} í˜•ì‹)
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - KAKAO_API_KEY=${KAKAO_API_KEY}

    # ì˜ì¡´ì„±: db ì»¨í…Œì´ë„ˆê°€ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•¨
    depends_on:
      db:
        condition: service_healthy

    restart: unless-stopped

    networks:
      - safetyfence-net

  # ============================================
  # 3. PostgreSQL + PostGIS ë°ì´í„°ë² ì´ìŠ¤
  # ============================================
  db:
    # PostGISê°€ í¬í•¨ëœ PostgreSQL ì´ë¯¸ì§€
    # 15 = PostgreSQL ë²„ì „, 3.3 = PostGIS ë²„ì „
    image: postgis/postgis:15-3.3-alpine

    container_name: safetyfence-db

    # ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸° ì„¤ì •
    environment:
      - POSTGRES_DB=safetyfence_db              # ìƒì„±í•  ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
      - POSTGRES_USER=${SPRING_DATASOURCE_USERNAME}            # ì‚¬ìš©ì ì´ë¦„ (.envì—ì„œ)
      - POSTGRES_PASSWORD=${SPRING_DATASOURCE_PASSWORD}        # ë¹„ë°€ë²ˆí˜¸ (.envì—ì„œ)

    command: >
      sh -c "
        if [ -d /docker-entrypoint-initdb.d ]; then
          if [ -w /docker-entrypoint-initdb.d ]; then
            echo 'ğŸ”§ Fixing safe permissions...';
            find /docker-entrypoint-initdb.d -type f -exec chmod 644 {} ';'
            find /docker-entrypoint-initdb.d -type d -exec chmod 755 {} ';'
            chown -R 999:999 /docker-entrypoint-initdb.d || true;
          else
            echo 'ğŸ”’ Read-only directory. Skipping permission fix.';
          fi;
        fi;
        exec docker-entrypoint.sh postgres
      "

    # ë³¼ë¥¨: ë°ì´í„°ë¥¼ ì˜êµ¬ ì €ì¥ (ì»¨í…Œì´ë„ˆ ì‚­ì œí•´ë„ ë°ì´í„° ìœ ì§€)
    volumes:
      - db-data:/var/lib/postgresql/data
      - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d

    # í¬íŠ¸ ë§¤í•‘ (ì™¸ë¶€ì—ì„œ ì§ì ‘ DB ì ‘ì†í•  ë•Œ ì‚¬ìš©, ë””ë²„ê¹…ìš©)
    ports:
      - "5432:5432"

    restart: unless-stopped

    networks:
      - safetyfence-net

    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${SPRING_DATASOURCE_USERNAME} -d safetyfence_db" ]
      interval: 5s
      timeout: 3s
      retries: 10

# ============================================
# ë³¼ë¥¨ ì •ì˜
# ============================================
# Dockerê°€ ê´€ë¦¬í•˜ëŠ” ì˜êµ¬ ì €ì¥ì†Œ
# ì»¨í…Œì´ë„ˆë¥¼ ì‚­ì œí•´ë„ ì´ ë³¼ë¥¨ì˜ ë°ì´í„°ëŠ” ìœ ì§€ë¨
volumes:
  db-data:
    # docker volume ls ëª…ë ¹ì–´ë¡œ í™•ì¸ ê°€ëŠ¥

# ============================================
# ë„¤íŠ¸ì›Œí¬ ì •ì˜
# ============================================
# ê°™ì€ ë„¤íŠ¸ì›Œí¬ì— ìˆëŠ” ì»¨í…Œì´ë„ˆë¼ë¦¬ë§Œ í†µì‹  ê°€ëŠ¥
# ì»¨í…Œì´ë„ˆ ì´ë¦„ìœ¼ë¡œ ì„œë¡œ ì°¾ì„ ìˆ˜ ìˆìŒ (ì˜ˆ: app -> db:5432)
networks:
  safetyfence-net:
    driver: bridge  # ê¸°ë³¸ ë„¤íŠ¸ì›Œí¬ ë“œë¼ì´ë²„
